name: Build and Push Container Image

on:
  workflow_call:
    inputs:
      tags:
        description: 'Tag to use for the image'
        type: string
        required: true
        default: 'dev'
    outputs:
      image_tags:
        description: 'Pushed image tags'
        value: ${{ jobs.build-and-push.outputs.tags }}

# 修复：移除多余的 actions: read 权限，只保留必要的权限
permissions:
  contents: read
  packages: write

env:
  IMAGE_REPOSITORY: qw4wer/subconv
  NUITKA_CACHE_AMD64: ${{ github.workspace }}/.nuitka-cache-amd64
  NUITKA_CACHE_ARM64: ${{ github.workspace }}/.nuitka-cache-arm64

jobs:
  # 新增：下载 build.yml 生成的 Artifacts
  download-build-artifacts:
    runs-on: ubuntu-latest
    outputs:
      arm64_artifact_path: ${{ steps.download.outputs.arm64_path }}
      amd64_artifact_path: ${{ steps.download.outputs.amd64_path }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 下载 ARM64 产物（对应 build.yml 上传的 artifact 名称）
      - name: Download ARM64 Build Artifact
        id: download-arm64
        uses: actions/download-artifact@v4
        with:
          name: subconv-ubuntu-latest-arm64  # 必须和 build.yml 中上传的名称一致
          path: ./artifacts/arm64

      # 下载 AMD64 产物
      - name: Download AMD64 Build Artifact
        id: download-amd64
        uses: actions/download-artifact@v4
        with:
          name: subconv-ubuntu-latest-x64
          path: ./artifacts/amd64

      - name: Output artifact paths
        run: |
          echo "arm64_path=${{ github.workspace }}/artifacts/arm64" >> $GITHUB_OUTPUT
          echo "amd64_path=${{ github.workspace }}/artifacts/amd64" >> $GITHUB_OUTPUT

  build-and-push:
    runs-on: ubuntu-latest
    needs: [setup, restore-nuitka-cache, download-build-artifacts]  # 依赖下载产物
    outputs:
      tags: ${{ steps.build.outputs.tags }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # 复制下载的产物到构建目录（关键：避免重新编译）
    - name: Copy Prebuilt Binaries
      run: |
        mkdir -p ./prebuilt/amd64 ./prebuilt/arm64
        cp ${{ needs.download-build-artifacts.outputs.amd64_artifact_path }}/api-linux-x64 ./prebuilt/amd64/api.bin
        cp ${{ needs.download-build-artifacts.outputs.arm64_artifact_path }}/api-linux-arm64 ./prebuilt/arm64/api.bin
        cp -r static ./prebuilt/  # 复制静态资源

    # 其余步骤（Set up Docker Buildx、登录）不变...

    # 修改 Build and push Docker image 步骤：使用多阶段构建，按架构复制产物
    - name: Build and push Docker image
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ needs.setup.outputs.tags }}
        platforms: ${{ needs.setup.outputs.architectures }}
        cache-from: type=local,src=${{ env.BUILDX_CACHE_DIR }}
        cache-to: type=local,dest=${{ env.BUILDX_CACHE_DIR }},mode=max
        # 关键：传递产物路径到 Dockerfile
        build-args: |
          PREBUILT_PATH=./prebuilt
