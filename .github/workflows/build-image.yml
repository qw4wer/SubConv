name: Build and Push Container Image

on:
  workflow_call:
    inputs:
      tags:
        description: 'Tag to use for the image'
        type: string
        required: true
        default: 'dev'
    outputs:
      image_tags:
        description: 'Pushed image tags'
        value: ${{ jobs.build-and-push.outputs.tags }}

# 彻底移除 actions: read 权限，仅保留必需的基础权限
permissions:
  contents: read
  packages: write

env:
  IMAGE_REPOSITORY: qw4wer/subconv
  BUILDX_CACHE_DIR: ${{ github.workspace }}/.buildx-cache

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      tags: ${{ steps.tag.outputs.TAG_NAME }}
      architectures: linux/amd64,linux/arm64
    steps:
      - id: tag
        run: |
          new_tag=""
          for tag in $(echo "${{ inputs.tags }}" | tr "," "\n"); do
            if [ -z "$new_tag" ]; then
              new_tag="${{ env.IMAGE_REPOSITORY }}:$tag"
            else
              new_tag="$new_tag,${{ env.IMAGE_REPOSITORY }}:$tag"
            fi
          done
          echo "TAG_NAME=$new_tag" >> $GITHUB_OUTPUT

  # 替代方案：从 GitHub Releases 下载预编译产物（无需 actions: read 权限）
  # 前提：build.yml 编译完成后，将产物上传到 GitHub Releases（见下方补充配置）
  download-build-artifacts:
    runs-on: ubuntu-latest
    outputs:
      arm64_artifact_path: ${{ github.workspace }}/artifacts/arm64
      amd64_artifact_path: ${{ github.workspace }}/artifacts/amd64
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 创建产物目录
      - name: Create artifact directories
        run: |
          mkdir -p ./artifacts/amd64 ./artifacts/arm64

      # 下载 AMD64 产物（替换为你的 Releases 下载链接）
      - name: Download AMD64 binary from Releases
        run: |
          # 示例：从 Releases 下载 api-linux-x64 文件
          curl -L \
            -o ./artifacts/amd64/api-linux-x64 \
            "https://github.com/qw4wer/SubConv/releases/download/dev/api-linux-x64"
          chmod +x ./artifacts/amd64/api-linux-x64

      # 下载 ARM64 产物
      - name: Download ARM64 binary from Releases
        run: |
          curl -L \
            -o ./artifacts/arm64/api-linux-arm64 \
            "https://github.com/qw4wer/SubConv/releases/download/dev/api-linux-arm64"
          chmod +x ./artifacts/arm64/api-linux-arm64

      # 验证产物是否下载成功
      - name: Verify Artifacts
        run: |
          echo "=== AMD64 Artifacts ==="
          ls -la ./artifacts/amd64
          echo "=== ARM64 Artifacts ==="
          ls -la ./artifacts/arm64

  build-and-push:
    runs-on: ubuntu-latest
    needs: [setup, download-build-artifacts]
    outputs:
      tags: ${{ steps.build.outputs.tags }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # 复制预编译产物到构建目录
    - name: Copy Prebuilt Binaries
      run: |
        mkdir -p ./prebuilt/amd64 ./prebuilt/arm64
        # 复制 AMD64 产物
        cp ${{ needs.download-build-artifacts.outputs.amd64_artifact_path }}/api-linux-x64 ./prebuilt/amd64/api.bin
        # 复制 ARM64 产物
        cp ${{ needs.download-build-artifacts.outputs.arm64_artifact_path }}/api-linux-arm64 ./prebuilt/arm64/api.bin
        # 复制静态资源（如有）
        cp -r static ./prebuilt/ || echo "Warning: static directory not found"
        # 确保可执行权限
        chmod +x ./prebuilt/amd64/api.bin ./prebuilt/arm64/api.bin

        # 校验产物架构（关键：避免 exec format error）
        echo "=== AMD64 binary architecture ==="
        file ./prebuilt/amd64/api.bin
        echo "=== ARM64 binary architecture ==="
        file ./prebuilt/arm64/api.bin

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        install: true
        driver-opts: network=host

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_HUB_USER }}
        password: ${{ secrets.DOCKER_HUB_TOKEN }}

    # 构建并推送多架构镜像
    - name: Build and push Docker image
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ needs.setup.outputs.tags }}
        platforms: ${{ needs.setup.outputs.architectures }}
        cache-from: type=local,src=${{ env.BUILDX_CACHE_DIR }}
        cache-to: type=local,dest=${{ env.BUILDX_CACHE_DIR }},mode=max
        build-args: |
          PREBUILT_PATH=./prebuilt

    - name: Output pushed tags
      run: |
        echo "tags=${{ needs.setup.outputs.tags }}" >> $GITHUB_OUTPUT
