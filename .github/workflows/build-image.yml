name: Build and Push Container Image

on:
  workflow_call:
    inputs:
      tags:
        description: 'Tag to use for the image'
        type: string
        required: true
        default: 'dev'
    outputs:
      image_tags:
        description: 'Pushed image tags'
        value: ${{ jobs.build-and-push.outputs.tags }}

# 修复：移除多余的 actions: read 权限，只保留必要的权限
permissions:
  contents: read
  packages: write

env:
  IMAGE_REPOSITORY: qw4wer/subconv
  NUITKA_CACHE_AMD64: ${{ github.workspace }}/.nuitka-cache-amd64
  NUITKA_CACHE_ARM64: ${{ github.workspace }}/.nuitka-cache-arm64

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      tags: ${{ steps.tag.outputs.TAG_NAME }}
      architectures: linux/amd64,linux/arm64
    steps:
      - id: tag
        run: |
          new_tag=""
          for tag in $(echo "${{ inputs.tags }}" | tr "," "\n"); do
            if [ -z "$new_tag" ]; then
              new_tag="${{ env.IMAGE_REPOSITORY }}:$tag"
            else
              new_tag="$new_tag,${{ env.IMAGE_REPOSITORY }}:$tag"
            fi
          done
          echo "TAG_NAME=$new_tag" >> $GITHUB_OUTPUT

  # 恢复 Nuitka 缓存（无需 actions: read 权限）
  restore-nuitka-cache:
    runs-on: ubuntu-latest
    outputs:
      cache-hit-amd64: ${{ steps.cache-amd64.outputs.cache-hit }}
      cache-hit-arm64: ${{ steps.cache-arm64.outputs.cache-hit }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 恢复 AMD64 缓存（仅用默认权限即可）
      - name: Restore Nuitka Cache (Linux AMD64)
        id: cache-amd64
        uses: actions/cache@v4
        with:
          path: ${{ env.NUITKA_CACHE_AMD64 }}
          key: nuitka-linux-x64-py311-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            nuitka-linux-x64-

      # 恢复 ARM64 缓存
      - name: Restore Nuitka Cache (Linux ARM64)
        id: cache-arm64
        uses: actions/cache@v4
        with:
          path: ${{ env.NUITKA_CACHE_ARM64 }}
          key: nuitka-linux-arm64-py311-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            nuitka-linux-arm64-

      # 验证并创建缓存目录
      - name: Verify Nuitka Cache
        run: |
          echo "AMD64 Cache Hit: ${{ steps.cache-amd64.outputs.cache-hit }}"
          echo "ARM64 Cache Hit: ${{ steps.cache-arm64.outputs.cache-hit }}"
          mkdir -p ${{ env.NUITKA_CACHE_AMD64 }} ${{ env.NUITKA_CACHE_ARM64 }}
          chmod -R 777 ${{ env.NUITKA_CACHE_AMD64 }} ${{ env.NUITKA_CACHE_ARM64 }}

  build-and-push:
    runs-on: ubuntu-latest
    needs: [setup, restore-nuitka-cache]
    outputs:
      tags: ${{ steps.build.outputs.tags }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        install: true
        driver-opts: network=host

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_HUB_USER }}
        password: ${{ secrets.DOCKER_HUB_TOKEN }}

    # 注入 AMD64 缓存
    - name: Inject Nuitka Cache for AMD64
      uses: reproducible-containers/buildkit-cache-dance@v2.1.4
      with:
        cache-source: ${{ env.NUITKA_CACHE_AMD64 }}
        cache-target: /root/.cache/Nuitka
        platform: linux/amd64

    # 注入 ARM64 缓存
    - name: Inject Nuitka Cache for ARM64
      uses: reproducible-containers/buildkit-cache-dance@v2.1.4
      with:
        cache-source: ${{ env.NUITKA_CACHE_ARM64 }}
        cache-target: /root/.cache/Nuitka
        platform: linux/arm64

    # 构建并推送镜像
    - name: Build and push Docker image
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ needs.setup.outputs.tags }}
        platforms: ${{ needs.setup.outputs.architectures }}
        cache-from: type=local,src=/tmp/.buildx-cache
        cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max
        build-args: |
          NUITKA_CACHE_PATH=/root/.cache/Nuitka
          PYTHON_VERSION=3.11
